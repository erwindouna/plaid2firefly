<!DOCTYPE html>
<html lang="en" x-data="plaidConfig()" class="bg-gray-100">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plaid2Firefly Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js" defer></script>
</head>
<body class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
    <h1 class="text-2xl font-semibold mb-6 text-center text-gray-800">Plaid2Firefly Setup</h1>

    <!-- Step 1: Configuration Form -->
    <template x-if="currentStep === 1">
      <form @submit.prevent="submitForm">
        <h2 class="text-lg font-medium text-gray-700 mb-4">Step 1: Configuration</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="plaid_client_id">Client ID</label>
          <input type="text" id="plaid_client_id" x-model="form.plaid_client_id" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="plaid_secret">Secret</label>
          <input type="password" id="plaid_secret" x-model="form.plaid_secret" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="plaid_env">Environment</label>
          <select id="plaid_env" x-model="form.plaid_env" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="sandbox">Sandbox</option>
            <option value="development">Development</option>
            <option value="production">Production</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="country_codes">Country Codes</label>
          <select id="country_codes" x-model="form.country_codes" multiple required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <template x-for="code in allowed_country_codes" :key="code">
              <option :value="code" x-text="code"></option>
            </template>
          </select>
          <p class="text-sm text-gray-500 mt-1">Hold down the Ctrl (Windows) or Command (Mac) key to select multiple options.</p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="firefly_url">Firefly III URL</label>
          <input type="url" id="firefly_url" x-model="form.firefly_url" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1" for="firefly_token">Firefly III Personal Access Token</label>
          <input type="text" id="firefly_token" x-model="form.firefly_token" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Save Configuration</button>
      </form>
    </template>

    <!-- Step 2: Get Public Token -->
    <template x-if="currentStep === 2">
      <div class="text-center">
        <h2 class="text-lg font-medium text-gray-700 mb-4">Step 2: Get Public Token</h2>
        <p class="mb-4 text-gray-700">Click the button below to generate a public token.</p>
        <button @click="getPublicToken" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
          Generate Public Token
        </button>
        <div x-show="public_token_success" class="mt-4 text-green-700 text-sm text-center">
            Public token generated successfully! You can now proceed to link your account. Redirecting in 3 seconds...
        </div>
      </div>
    </template>

    <!-- Step 3: Link Account -->
    <template x-if="currentStep === 3">
      <div class="text-center">
        <h2 class="text-lg font-medium text-gray-700 mb-4">Step 3: Link Account</h2>
        <p class="mb-4 text-gray-700">Click the button below to link your account.</p>
        <button @click="startLinking" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
          Start Linking Process
        </button>
      </div>
    </template>

    <div x-show="submitted" class="mt-4 text-green-700 text-sm text-center">
      Configuration saved successfully!
    </div>
  </div>

  <script>
    function plaidConfig() {
      return {
        currentStep: 1,
        form: {
          plaid_client_id: '',
          plaid_secret: '',
          plaid_env: 'sandbox',
          firefly_url: '',
          firefly_token: '',
          country_codes: [] // Change to an array for multi-select
        },
        allowed_country_codes: [], // Store allowed country codes
        link_token: false,
        submitted: false,
        public_token_success: false,

        async fetchConfig() {
          try {
            const response = await fetch('/config');
            if (!response.ok) {
              console.error('Failed to fetch configuration:', response.statusText);
              this.currentStep = 1; // Default to step 1 on error
              return; // Early return
            }

            const config = await response.json();
            this.form.plaid_client_id = config.PLAID_CLIENT_ID || '';
            this.form.plaid_secret = config.PLAID_SECRET || '';
            this.form.plaid_env = config.PLAID_ENV || 'sandbox';
            this.form.firefly_url = config.FIREFLY_URL || '';
            this.form.firefly_token = config.FIREFLY_TOKEN || '';
            this.form.country_codes = config.COUNTRY_CODES || []; // Ensure country_codes is an array
            this.link_token = !!config.LINK_TOKEN;

            // Check if all required fields for step 1 are filled
            const isStep1Complete = this.form.plaid_client_id &&
                                    this.form.plaid_secret &&
                                    this.form.firefly_url &&
                                    this.form.firefly_token &&
                                    this.form.country_codes.length > 0; // Ensure at least one country code is selected

            // Determine the current step based on the data
            if (!isStep1Complete) {
              this.currentStep = 1; // Stay on step 1 if configuration is incomplete
              return; // Early return
            }

            this.currentStep = this.link_token ? 3 : 2; // Go to step 3 if link_token exists, otherwise step 2
          } catch (error) {
            console.error('Error fetching configuration:', error);
            this.currentStep = 1; // Default to step 1 on error
          }
        },

        async fetchCountryCodes() {
          try {
            const response = await fetch('/get-country-codes');
            if (!response.ok) {
              console.error('Failed to fetch country codes:', response.statusText);
              return; // Early return
            }

            const data = await response.json();
            this.allowed_country_codes = data.allowed_country_codes || [];
          } catch (error) {
            console.error('Error fetching country codes:', error);
          }
        },

        async submitForm() {
          try {
            const response = await fetch('/update-config', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(this.form),
            });

            if (!response.ok) {
              console.error('Failed to submit configuration:', response.statusText);
              return; // Early return
            }

            this.submitted = true;
            this.currentStep = 2;
          } catch (error) {
            console.error('Error submitting configuration:', error);
          }
        },

        async getPublicToken() {
          try {
            const response = await fetch('/get-public-token', { method: 'GET' });
            if (!response.ok) {
              console.error('Failed to generate public token:', response.statusText);
              return; // Early return
            }

            console.log('Public token generated successfully.');
            this.public_token_success = true;

            // Wait for 3 seconds before updating the current step
            setTimeout(() => {
              this.currentStep = 3;
              this.public_token_success = false;
            }, 3000);
          } catch (error) {
            console.error('Error generating public token:', error);
          }
        },

        async startLinking() {
          try {
            Plaid.create({
              token: '{{ session.get("PLAID_LINK_TOKEN") }}',
              onSuccess: function(public_token, metadata) {
                console.log('Public token is:', public_token);
                fetch('/save-public-token', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ public_token }),
                }).then(response => {
                  if (!response.ok) {
                    console.error('Failed to save public token:', response.statusText);
                    return; // Early return
                  }
                  console.log('Public token saved successfully.');
                });
              },
              onExit: function(err, metadata) {
                console.log('onExit invoked:', err);
              },
              onEvent: function(eventName, metadata) {
                console.log('Event name is:', eventName);
              }
            }).open();
          } catch (error) {
            console.error('Error starting linking process:', error);
          }
        },

        init() {
          this.fetchCountryCodes(); // Fetch country codes on initialization
          this.fetchConfig(); // Fetch configuration on initialization
        }
      }
    }
  </script>
</body>
</html>
